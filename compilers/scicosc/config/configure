#!/bin/sh

#######################################################################
#                                                                     #
#                           Simport                                   #
#                                                                     #
#          Pierre Weis, INRIA Rocquencourt                            #
#                                                                     #
#  Copyright 2010-2013,                                               #
#  Institut National de Recherche en Informatique et en Automatique.  #
#  All rights reserved.                                               #
#                                                                     #
#  This file is distributed under the terms of the BSD License.       #
#                                                                     #
#######################################################################

# $Id: configure 6237 2013-10-24 22:48:46Z weis $

######################################
# set_value x val 
# set x value to va if x has no value 
######################################

set_value () {
  ok=false
  eval \$$1 2> /dev/null || ok=true;
  if test $ok = "false"; then 
    eval $1='$2';
  fi 
}

test_set_value () {
    ok=true
    x=10;
    set_value x 20;
    set_value y 20;
    echo result $x $y
    if test "$x" != 10 -o "$y" != 20; then
	echo "test failed" 
    fi
}
# test_set_value 

##################################
# default values computed here 
# if variables are not already set
##################################

set_value SRC_ROOT_DIR   "`pwd`/../" 
set_value PREFIX_INSTALL_DIR  "/usr/local"
set_value SRC_INSTALL_DIR  "${SRC_ROOT_DIR}"
set_value OCAMLC  ocamlc 
set_value OCAMLOPT  ocamlopt
set_value CAML_BYT_COMP_FLAGS "-strict-sequence -warn-error Ae -annot -g"
set_value CAML_BIN_COMP_FLAGS "-strict-sequence -w Ae -unsafe -noassert -inline 10000"

set_value OCAMLLIB  `$OCAMLC -where 2>/dev/null || $OCAMLC -v|tail -1|cut -d ' ' -f 4`
set_value OCAMLLEX  ocamllex 
set_value OCAMLYACC  ocamlyacc
set_value OCAMLDEP ocamldep
set_value OCAMLDEP_FLAGS "-slash"
set_value OCAMLPRINTC "touch" 
set_value OCAMLPRINTC_FLAGS "-c"

# Tools: Htmlc file generator.
# Configuration of Htmlc to generate Web pages:
# where are include files
set_value HTMLC_CONF_INCLUDES ""
# where is the configuration file for Htmlc.
set_value HTMLC_CONF_ENV "" 
# Additional flags to set in Makefiles
set_value HTMLC_FLAGS  "-lang en -honor_line_continuation true"
set_value HTMLC_COMMAND "touch"

if test "$HTMLC_COMMAND" = "touch"; then
    HTMLC_FLAGS="-c"
    HTMLC_CONF_ENV=""
    HTMLC_CONF_INCLUDES=""
fi

if test "$OCAMLPRINTC" = "touch"; then
    OCAMLPRINTC_FLAGS="-c"
fi

set_value OCAMLVERSION  `$OCAMLC -v | sed -n -e 's|.*version* *\(.*\)$|\1|p'`
set_value OCAML_VERSION_MAJOR  `echo $OCAMLVERSION | cut -d . -f 1`
set_value OCAML_VERSION_MINOR  `echo $OCAMLVERSION | cut -d . -f 2`

# generate Config.mk

GENERATED=Config.mk

rm -f $GENERATED

echo "# -*- mode : Makefile -*-"  > $GENERATED 
echo "#" >> $GENERATED
echo "# Warning: this file has been generated." >> $GENERATED
echo "#" >> $GENERATED
echo "# DO NOT EDIT THIS FILE!" >> $GENERATED
echo "#" >> $GENERATED
echo "# The editable source of this file is in $GENERATED.in" >> $GENERATED
echo "#" >> $GENERATED

sed \
    -e "s|@SRC_ROOT_DIR@|$SRC_ROOT_DIR|" \
    -e "s|@PREFIX_INSTALL_DIR@|$PREFIX_INSTALL_DIR|" \
    -e "s|@SRC_INSTALL_DIR@|$SRC_INSTALL_DIR|" \
    -e "s|@OCAMLC@|$OCAMLC|" \
    -e "s|@OCAMLOPT@|$OCAMLOPT|" \
    -e "s|@CAML_BYT_COMP_FLAGS@|$CAML_BYT_COMP_FLAGS|" \
    -e "s|@CAML_BIN_COMP_FLAGS@|$CAML_BIN_COMP_FLAGS|" \
    -e "s|@OCAMLLIB@|$OCAMLLIB|" \
    -e "s|@OCAMLLEX@|$OCAMLLEX|" \
    -e "s|@OCAMLYACC@|$OCAMLYACC|" \
    -e "s|@OCAMLDEP@|$OCAMLDEP|" \
    -e "s|@OCAMLDEP_FLAGS@|$OCAMLDEP_FLAGS|" \
    -e "s|@OCAMLPRINTC@|$OCAMLPRINTC|" \
    -e "s|@OCAMLPRINTC_FLAGS@|$OCAMLPRINTC_FLAGS|" \
    -e "s|@HTMLC_CONF_INCLUDES@|$HTMLC_CONF_INCLUDES|" \
    -e "s|@HTMLC_CONF_ENV@|$HTMLC_CONF_ENV|" \
    -e "s|@HTMLC_FLAGS@|$HTMLC_FLAGS|" \
    -e "s|@HTMLC_COMMAND@|$HTMLC_COMMAND|" \
    -e "s|@OCAMLVERSION@|$OCAMLVERSION|" \
    -e "s|@OCAML_VERSION_MAJOR@|$OCAML_VERSION_MAJOR|" \
    -e "s|@OCAML_VERSION_MINOR@|$OCAML_VERSION_MINOR|" \
$GENERATED.in >> $GENERATED

chmod -w $GENERATED

